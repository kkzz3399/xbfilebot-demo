# 并发与会话问题修复 - 测试指南

## 测试前准备

1. 确保已安装所有依赖：
   ```bash
   pip install pyrogram tgcrypto aiohttp
   ```

2. 配置 config.py（如果还没有的话）：
   - API_ID 和 API_HASH
   - BOT_TOKEN
   - TARGET_CHAT_ID
   - ADMIN_USER_IDS

3. 启动机器人：
   ```bash
   python3 main.py
   ```

## 测试用例

### 1. ReplyKeyboard 主导航测试

**步骤：**
1. 向机器人发送 `/start` 命令
2. 检查是否显示 ReplyKeyboard（底部键盘）
3. 验证按钮根据权限显示：
   - 管理员：应该看到所有按钮（包括"广播"、"添加管理员"）
   - VIP：应该看到"开始上传"、"管理文件夹"等
   - 普通用户：应该看到"购买会员"、"兑换卡密"等

**预期结果：**
- ✅ 显示 ReplyKeyboard
- ✅ 按钮根据权限正确显示
- ✅ 显示欢迎消息："🎉 欢迎使用云存储机器人！"

### 2. 上传流程测试（Flow 管理）

**步骤：**
1. 点击"📤 开始上传"按钮
2. 应该收到提示："✅ 上传批次已创建！"
3. 发送一张图片或文件
4. 验证文件只被处理一次（检查控制台日志）
5. 再次发送同一文件
6. 验证消息去重是否生效

**预期结果：**
- ✅ 创建上传批次
- ✅ 文件被正确处理
- ✅ 不会被其他处理器抢占
- ✅ 重复消息被去重（10秒内）
- ✅ 控制台显示：`[upload.debug] explicit_upload validated for {user_id}`

### 3. 绑定机器人测试（Reply-to-Prompt）

**步骤：**
1. 点击"🔐 绑定机器人"按钮
2. 应该收到绑定教程
3. 点击"✅ 我已创建并准备粘贴 token"
4. 应该收到提示："请在下面回复 token"
5. 发送一个测试 token（格式：123456789:AAABBBcccDDD...）
6. 验证 token 验证流程

**预期结果：**
- ✅ 显示绑定教程
- ✅ 设置 bind_bot flow
- ✅ 只接受回复提示消息的 token
- ✅ 异步验证 token（带超时）
- ✅ 控制台显示：`[bindbot] token validated for user {user_id}`

### 4. 广告图流程测试（Flow 隔离）

**步骤：**
1. 先点击"📤 开始上传"
2. 上传一张图片
3. 点击"✅ 完成加密上传"
4. 点击"🖼️ 生成广告图"
5. 上传封面图片
6. 验证封面图片不会被上传流程处理

**预期结果：**
- ✅ 封面图片进入 buttonpost 流程
- ✅ 不会被 upload 流程抢占
- ✅ 控制台显示：`[buttonpost.debug] buttonpost handled message`
- ✅ 显示编辑按钮界面

### 5. 文件夹管理测试（辅助函数）

**步骤：**
1. 点击"📁 管理文件夹"按钮
2. 如果有文件夹，应该显示列表
3. 如果没有文件夹，显示提示

**预期结果：**
- ✅ 正确显示文件夹列表
- ✅ 使用 get_user_folders 辅助函数
- ✅ 数据格式正确

### 6. 回调兜底测试

**步骤：**
1. 使用开发者工具或修改代码触发一个不存在的 callback_data
2. 例如：创建一个按钮 callback_data="test_nonexistent"
3. 点击该按钮

**预期结果：**
- ✅ 控制台显示：`[callback_fallback] 收到未匹配 callback -> data='test_nonexistent'`
- ✅ 按钮不会卡住（自动 answer）
- ✅ 用户界面正常

### 7. 消息去重测试

**步骤：**
1. 进入上传流程
2. 快速发送同一文件多次（10秒内）
3. 查看控制台日志

**预期结果：**
- ✅ 第一次：正常处理
- ✅ 后续：显示 `[upload.debug] duplicate message {message_id} from {user_id}, skipping`
- ✅ 文件只被处理一次

### 8. Flow TTL 测试

**步骤：**
1. 进入上传流程但不发送文件
2. 等待超过 1 小时（或修改 EXPLICIT_UPLOAD_TTL 为更短时间测试）
3. 尝试发送文件

**预期结果：**
- ✅ Flow 自动过期
- ✅ 文件被拒绝
- ✅ 显示提示："上传批次已过期，请重新点击"

## 压力测试

### 并发测试

**步骤：**
1. 使用多个账号同时操作
2. 每个账号进入不同的流程
3. 验证各个流程互不干扰

**预期结果：**
- ✅ 每个用户的 flow 独立管理
- ✅ 不会互相抢占消息
- ✅ DB 操作线程安全

## 日志检查

启动机器人后，应该看到：

```
==================================================
🚀 云存储机器人正在启动...
==================================================
📊 数据库初始化完成
📝 注册核心处理器...
✅ VIP 中心模块已注册
✅ 机器人绑定模块导入成功
✅ 机器人绑定处理器已注册
✅ 用户机器人管理器已设置
✅ 广播、广告图、分享模块已注册
✅ 通用处理器已注册
✅ 回调处理器和调试日志已注册
✅ 回调兜底处理器已注册
✅ 机器人已启动成功
✅ 用户机器人管理器: load_all() 已调用
```

停止时应该看到：

```
🛑 正在停止机器人...
✅ 机器人已停止
👋 程序已退出
```

## 常见问题排查

### 问题：ReplyKeyboard 不显示

**解决方案：**
- 检查 /start 是否返回 ReplyKeyboardMarkup
- 某些 Telegram 客户端需要重启才能显示

### 问题：Flow 没有保存到数据库

**解决方案：**
- 检查 data/users.db 是否存在
- 检查 user_flows 表是否创建：
  ```sql
  SELECT * FROM user_flows;
  ```

### 问题：消息仍然被多个处理器处理

**解决方案：**
- 检查 flowguards 是否正常工作
- 查看控制台日志确认 flow 状态
- 验证处理器的 group 优先级设置

## 测试完成标准

所有测试用例应该通过：
- ✅ ReplyKeyboard 正常显示
- ✅ 上传流程不被抢占
- ✅ 绑定机器人使用回复提示
- ✅ 广告图流程独立
- ✅ 消息去重生效
- ✅ 回调兜底捕获未匹配回调
- ✅ Flow TTL 正确过期
- ✅ 日志清晰易读

## 性能指标

- Flow 查询响应时间：< 10ms
- 消息去重检查：< 5ms
- 数据库操作：使用 db_lock 保护
- 内存使用：合理（定期清理过期记录）
